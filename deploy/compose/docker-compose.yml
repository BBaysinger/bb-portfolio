# =============================================================================
# Docker Compose Configuration - BB Portfolio Site
# =============================================================================
#
# This configuration supports multiple deployment environments using profiles:
# - Local development (MacBook) with hot reload and volume mounts
# - AWS EC2 development sandbox with builds on EC2
# - AWS EC2 production with pre-built ECR images
#
# QUICK START - Local Development:
# --------------------------------
# 1. Build and start services:
#    COMPOSE_PROFILES=local docker compose up --build
#
# 2. Access your applications:
#    - Frontend: http://localhost:8080 (with hot reload)
#    - Backend:  http://localhost:8081 (with auto-restart)
#
# 3. Stop services:
#    COMPOSE_PROFILES=local docker compose down
#
# USAGE BY ENVIRONMENT:
# ---------------------
#   ▶ Local Development (MacBook):
#     COMPOSE_PROFILES=local docker compose up --build
#
#   ▶ AWS EC2 Production Only:
#     COMPOSE_PROFILES=prod docker compose up -d
#
#   ▶ AWS EC2 Development Only:
#     COMPOSE_PROFILES=dev docker compose up -d --build
#
#   ▶ AWS EC2 Both Environments:
#     COMPOSE_PROFILES=prod,dev docker compose up -d
#
# DEPLOYMENT STRATEGY:
# -------------------
#   ▶ Production: Automated via CI/CD on main branch
#     - Uses pre-built ECR images for fast, reliable deployments
#     - Images are built, tested, and pushed by GitHub Actions
#     - Zero build time on EC2, atomic deployments
#
#   ▶ Development: Manual trigger via workflow_dispatch
#     - Builds directly on EC2 for flexibility
#     - No ECR push, saves CI/CD minutes and complexity
#     - Perfect for testing and iteration
#
# =============================================================================

services:
  # =============================================================================
  # PRODUCTION SERVICES (AWS EC2)
  # =============================================================================
  # These services run optimized production builds with:
  # - Pre-built ECR images (no build time on deployment)
  # - Health checks for reliability and load balancer integration
  # - Automatic restart policies for high availability
  # - Production environment variables and secrets
  # - Atomic deployments via docker compose pull + up -d
  # =============================================================================

  bb-portfolio-backend-prod:
    profiles: ["prod"] # Only runs with COMPOSE_PROFILES=prod
    # Use a safe default for AWS_ACCOUNT_ID to avoid Compose warnings when not set during local/dev runs.
    # In real prod runs, ensure AWS_ACCOUNT_ID is exported so the image resolves to your ECR registry.
    image: "${AWS_ACCOUNT_ID:-000000000000}.dkr.ecr.us-west-2.amazonaws.com/bb-portfolio-backend-prod:latest"
    container_name: bb-portfolio-backend-prod
    ports:
      - "3001:3000" # Backend gets xxx1 for production
    env_file:
      - ../../backend/.env.prod
    restart: unless-stopped # Auto-restart on failure/reboot
    networks:
      default: {}
    # Enable access to EC2 metadata service for IAM credentials
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - AWS_REGION=us-west-2
      - AWS_DEFAULT_REGION=us-west-2
    healthcheck: # HTTP health check against backend endpoint
      test:
        [
          "CMD",
          "node",
          "-e",
          "const http=require('http'); const req=http.get('http://localhost:3000/api/health/',res=>{process.exit(res.statusCode===200?0:1)}); req.on('error',()=>process.exit(1));",
        ]
      interval: 15s
      timeout: 5s
      retries: 25
      start_period: 30s

  bb-portfolio-frontend-prod:
    profiles: ["prod"] # Only runs with COMPOSE_PROFILES=prod
    # Use a safe default for AWS_ACCOUNT_ID to avoid Compose warnings when not set during local/dev runs.
    # In real prod runs, ensure AWS_ACCOUNT_ID is exported so the image resolves to your ECR registry.
    image: "${AWS_ACCOUNT_ID:-000000000000}.dkr.ecr.us-west-2.amazonaws.com/bb-portfolio-frontend-prod:latest"
    container_name: bb-portfolio-frontend-prod
    ports:
      - "3000:3000" # Frontend gets xxx0 for production
    env_file:
      - ../../frontend/.env.prod
    # Enable access to EC2 metadata service for IAM credentials
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - AWS_REGION=us-west-2
      - AWS_DEFAULT_REGION=us-west-2
    restart: unless-stopped # Auto-restart on failure/reboot
    depends_on:
      bb-portfolio-backend-prod:
        condition: service_started # Just wait for backend to start, not be healthy
    healthcheck: # Simple TCP/HTTP readiness for frontend server
      test:
        [
          "CMD",
          "node",
          "-e",
          "const net = require('net'); const client = net.createConnection(3000, 'localhost', () => { console.info('connected'); client.end(); process.exit(0); }); client.on('error', () => process.exit(1));",
        ]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 30s

  # =============================================================================
  # DEVELOPMENT SERVICES (AWS EC2 Sandbox)
  # =============================================================================
  # These services run on EC2 for remote development/testing:
  # - Pull pre-built images from Docker Hub (fast deployments)
  # - Images built and pushed via CI/CD on dev branch pushes
  # - Different ports to avoid conflicts with production
  # - Cost-optimized using free Docker Hub public repositories
  # - Provides experience with dual-registry strategy (Docker Hub + ECR)
  # =============================================================================

  bb-portfolio-backend-dev:
    profiles: ["dev"] # Only runs with COMPOSE_PROFILES=dev
    image: bhbaysinger/bb-portfolio-backend:dev # Pre-built image from Docker Hub
    container_name: bb-portfolio-backend-dev
    ports:
      - "4001:3000" # Backend gets xxx1
    env_file:
      - ../../backend/.env.dev
    restart: unless-stopped # Auto-restart on failure/reboot
    networks:
      default: {}
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "const http=require('http'); const req=http.get('http://localhost:3000/api/health/',res=>{process.exit(res.statusCode===200?0:1)}); req.on('error',()=>process.exit(1));",
        ]
      interval: 15s
      timeout: 5s
      retries: 10
      start_period: 30s

  bb-portfolio-frontend-dev:
    profiles: ["dev"] # Only runs with COMPOSE_PROFILES=dev
    image: bhbaysinger/bb-portfolio-frontend:dev # Pre-built image from Docker Hub
    container_name: bb-portfolio-frontend-dev
    ports:
      - "4000:3000" # Frontend gets xxx0
    env_file:
      - ../../frontend/.env.dev
    environment:
      - PORT=3000
    restart: unless-stopped # Auto-restart on failure/reboot
    depends_on:
      bb-portfolio-backend-dev:
        condition: service_started # Wait for backend (no health check needed)

  # =============================================================================
  # LOCAL DEVELOPMENT SERVICES (MacBook)
  # =============================================================================
  # These services are optimized for local development with:
  # - Hot reload and auto-restart capabilities
  # - Volume mounts for live code editing (no rebuild needed)
  # - Development builds with full dependencies and debugging tools
  # - File watching for automatic updates via CHOKIDAR_USEPOLLING
  # - Named volumes to preserve node_modules across container restarts
  # =============================================================================

  bb-portfolio-backend-local:
    profiles: ["local"]
    image: bhbaysinger/bb-portfolio-backend:dev
    container_name: bb-portfolio-backend-local
    working_dir: /app
    # Install deps if missing, then run Next dev on the expected port
    command: ["/bin/sh", "-lc", "sh scripts/entrypoint.dev.sh"]
    volumes:
      - ../../backend:/app
      - /app/node_modules
    ports:
      - "8081:3001"
    env_file:
      - ../../backend/.env
    environment:
      CHOKIDAR_USEPOLLING: "true"
      NODE_ENV: development
      PORT: "3001"
      ENV_PROFILE: local
      NPM_CONFIG_CACHE: /app/.npm-cache
      # Disk usage guardrails (warn/fail thresholds in percent). Adjust as needed.
      DISK_WARN_PCT: "85"
      DISK_FAIL_PCT: "95"
      DISK_CHECK_PATHS: "/tmp"
    restart: unless-stopped

  bb-portfolio-frontend-local:
    profiles: ["local"]
    image: bhbaysinger/bb-portfolio-frontend:dev
    container_name: bb-portfolio-frontend-local
    working_dir: /app
    # Install deps if missing, then run Next dev
    command: ["/bin/sh", "-lc", "sh scripts/entrypoint.dev.sh"]
    volumes:
      - ../../frontend:/app
      - frontend_node_modules:/app/node_modules
    ports:
      - "3000:3000"
    env_file:
      - ../../frontend/.env
    environment:
      CHOKIDAR_USEPOLLING: "true"
      REACT_STRICT_MODE: "${REACT_STRICT_MODE:-true}"
      NODE_ENV: development
      ENV_PROFILE: local
      # API calls are relative; proxy routes /api to backend
      NPM_CONFIG_CACHE: /app/.npm-cache
      # Disk usage guardrails (warn/fail thresholds in percent). Adjust as needed.
      DISK_WARN_PCT: "85"
      DISK_FAIL_PCT: "95"
      DISK_CHECK_PATHS: "/tmp"
    restart: unless-stopped
    depends_on:
      bb-portfolio-backend-local:
        condition: service_started

  # =============================================================================
  # OPTIONAL LOCAL REVERSE PROXY (Caddy)
  # =============================================================================
  # Enable with: COMPOSE_PROFILES=local,proxy docker compose up
  # This mirrors the production routing pattern locally while keeping hot reload.
  caddy-local:
    profiles: ["proxy"]
    image: caddy:alpine
    container_name: bb-portfolio-caddy-local
    ports:
      - "8080:80"
      - "8443:443"
    volumes:
      - ../caddy/Caddyfile:/etc/caddy/Caddyfile:ro
    depends_on:
      bb-portfolio-frontend-local:
        condition: service_started
      bb-portfolio-backend-local:
        condition: service_started
    networks:
      default: {}

  # =============================================================================
  # LOCAL (MacBook) DEVELOPMENT SERVICES WITH SGG GENERATION
  # =============================================================================

  bb-portfolio-backend-local-ssg-generate:
    profiles: ["local-ssg"]
    image: bhbaysinger/bb-portfolio-backend:dev
    container_name: bb-portfolio-backend-local-ssg-generate
    volumes:
      - ../../backend:/app
      - /app/node_modules
    ports:
      - "8081:3001"
    env_file:
      - ../../backend/.env
    environment:
      - CHOKIDAR_USEPOLLING=true
      - PORT=3001
    restart: unless-stopped

  bb-portfolio-frontend-local-ssg-generate:
    profiles: ["local-ssg"]
    image: bhbaysinger/bb-portfolio-frontend:dev
    container_name: bb-portfolio-frontend-local-ssg-generate
    command: sh -c "npm run build:when-ready && npm start"
    volumes:
      - ../../frontend:/app
      # - frontend_node_modules:/app/node_modules
    ports:
      - "8080:3000"
    env_file:
      - ../../frontend/.env
    environment:
      - CHOKIDAR_USEPOLLING=true
      - REACT_STRICT_MODE=${REACT_STRICT_MODE:-true}
      # API calls are relative; proxy routes /api to backend
    restart: unless-stopped
    depends_on:
      bb-portfolio-backend-local-ssg-generate:
        condition: service_started

# =============================================================================
# NETWORKING & STORAGE
# =============================================================================

# Custom network for service isolation and communication
networks:
  default:
    name: bb-portfolio-network # Named network for better organization

# Named volumes for persistent data
volumes:
  # Preserves frontend node_modules in local development
  # Prevents host directory from overriding container's installed dependencies
  frontend_node_modules: # Used by bb-portfolio-frontend-local service

