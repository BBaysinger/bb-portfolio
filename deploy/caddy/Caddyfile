:80 {
    # Admin routes go to backend container
    handle /admin* {
        reverse_proxy bb-portfolio-backend-local:3001 {
            header_up Host {host}
            header_up X-Forwarded-Proto {scheme}
            header_up X-Forwarded-Host {host}
        }
    }
    
    # Public API resolves directly at /api/* (basePath removed)
    handle /api* {
        reverse_proxy bb-portfolio-backend-local:3001 {
            header_up Host {host}
            header_up X-Forwarded-Proto {scheme}
            header_up X-Forwarded-Host {host}
        }
    }
    
    # PayloadCMS specific static assets (based on path patterns)
    handle /_next/static/css/app/(payload)/* {
        reverse_proxy bb-portfolio-backend-local:3001 {
            header_up Host {host}
            header_up X-Forwarded-Proto {scheme}
            header_up X-Forwarded-Host {host}
        }
    }
    
    handle /_next/static/chunks/app/(payload)/* {
        reverse_proxy bb-portfolio-backend-local:3001 {
            header_up Host {host}
            header_up X-Forwarded-Proto {scheme}
            header_up X-Forwarded-Host {host}
        }
    }
    
    handle /_next/static/media/payload-* {
        reverse_proxy bb-portfolio-backend-local:3001 {
            header_up Host {host}
            header_up X-Forwarded-Proto {scheme}
            header_up X-Forwarded-Host {host}
        }
    }

    # Generic Next static assets requested from Admin pages
    # When browsing /admin, the HTML references root-level /_next assets.
    # Use the Referer header to send those to the backend app, not the frontend.
    @admin_next_static {
        path /_next/*
        header_regexp admin_ref Referer .*/admin(/|$|.*)
    }
    handle @admin_next_static {
        reverse_proxy bb-portfolio-backend-local:3001 {
            header_up Host {host}
            header_up X-Forwarded-Proto {scheme}
            header_up X-Forwarded-Host {host}
        }
    }
    
    # Everything else goes to frontend container
    handle {
    reverse_proxy bb-portfolio-frontend-local:3000
    }
}