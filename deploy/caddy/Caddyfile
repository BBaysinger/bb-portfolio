:80 {
    # Admin routes go to backend container
    handle /admin* {
        reverse_proxy backend-local:3001
    }
    
    # API routes go to backend container  
    handle /api/* {
        reverse_proxy backend-local:3001
    }
    
    # PayloadCMS specific static assets (based on path patterns)
    handle /_next/static/css/app/(payload)/* {
        reverse_proxy backend-local:3001
    }
    
    handle /_next/static/chunks/app/(payload)/* {
        reverse_proxy backend-local:3001
    }
    
    handle /_next/static/media/payload-* {
        reverse_proxy backend-local:3001
    }

    # Generic Next static assets requested from Admin pages
    # When browsing /admin, the HTML references root-level /_next assets.
    # Use the Referer header to send those to the backend app, not the frontend.
    @admin_next_static {
        path /_next/*
        header_regexp admin_ref Referer .*/admin(/|$|.*)
    }
    handle @admin_next_static {
        reverse_proxy backend-local:3001
    }
    
    # Everything else goes to frontend container
    handle {
        reverse_proxy frontend-local:3000
    }
}