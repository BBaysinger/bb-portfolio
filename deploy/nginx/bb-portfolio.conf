# Unified Nginx reverse proxy config for bb-portfolio
# Copy to /etc/nginx/conf.d/bb-portfolio.conf on the EC2 host then: nginx -t && systemctl reload nginx
# Domains:
#   Production: bbaysinger.com, www.bbaysinger.com
#   Development: dev.bbaysinger.com
# Upstreams (container host ports):
#   Prod Frontend  : 3000
#   Prod Backend   : 3001
#   Dev Frontend   : 4000
#   Dev Backend    : 4001
# Health endpoints:
#   /api/health/ (backend) and /healthz (static) for quick probes.

map $http_upgrade $connection_upgrade { default upgrade; '' close; }

# Shared proxy settings (global nginx.conf already sets types_hash_max_size)
# Avoid duplicating global tunables here to prevent reload failures.
proxy_http_version 1.1;
proxy_set_header X-Real-IP $remote_addr;
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
proxy_set_header X-Forwarded-Proto $scheme;
proxy_set_header Host $host;
proxy_set_header Upgrade $http_upgrade;
proxy_set_header Connection $connection_upgrade;
proxy_read_timeout 60s;

# PROD SERVER BLOCK
server {
  listen 80;
  server_name bbaysinger.com www.bbaysinger.com;

  # Serve image requests directly; suppress Next.js HTML 404 pages for missing images.
  # If file not found, return an empty 404 response (no HTML body) so <img> alt text can show.
  location ~* \.(?:png|jpe?g|gif|webp|svg|avif)$ {
    try_files $uri $uri/ =404;
    # For 404 generated above, override default error page with empty body
    error_page 404 = @empty_image_404;
    access_log off;
    add_header Cache-Control "public, max-age=3600";
  }
  location @empty_image_404 {
    # Empty 404 body (no HTML). Browsers treat as broken image gracefully.
    return 404 "";
  }

  # Static emergency health
  location = /healthz { return 200 'ok'; add_header Content-Type text/plain; }

  # Admin UI and assets → Backend (Prod)
  # Normalize bare /admin to trailing-slash to satisfy Next trailingSlash=true
  location = /admin { return 308 /admin/; }
  location ^~ /admin/ { proxy_pass http://127.0.0.1:3001; }
  # Ensure admin assetPrefix works when Next emits /admin/_next/*
  location ^~ /admin/_next/ { proxy_pass http://127.0.0.1:3001; }
  # Payload/Next admin-specific static emitted under root _next (defensive)
  location ~ ^/_next/static/(css|chunks)/app/(payload)/ { proxy_pass http://127.0.0.1:3001; }
  location ~ ^/_next/static/media/payload- { proxy_pass http://127.0.0.1:3001; }

  # Backend API (Prod)
  location /api/ {
    # Preserve /api prefix (no trailing slash on upstream) so /api/health stays /api/health
    proxy_pass http://127.0.0.1:3001;
  }

  # Next.js static assets (hashed) – pass through without HTML no-store headers
  location ^~ /_next/ {
    proxy_pass http://127.0.0.1:3000;
  }

  # Everything else → Frontend (Prod)
  location / {
    proxy_pass http://127.0.0.1:3000/;
    # Do not cache HTML/doc responses; let hashed assets under /_next/ use upstream caching
    add_header Cache-Control "private, no-store, must-revalidate" always;
  }
}

# DEV SERVER BLOCK
server {
  listen 80;
  server_name dev.bbaysinger.com;

  # Dev image handling identical to prod (no HTML error pages)
  location ~* \.(?:png|jpe?g|gif|webp|svg|avif)$ {
    try_files $uri $uri/ =404;
    error_page 404 = @empty_image_404_dev;
    access_log off;
    add_header Cache-Control "public, max-age=60";
  }
  location @empty_image_404_dev { return 404 ""; }

  location = /healthz { return 200 'ok'; add_header Content-Type text/plain; }

  # Admin UI and assets → Backend (Dev)
  # Normalize bare /admin to trailing-slash to satisfy Next trailingSlash=true
  location = /admin { return 308 /admin/; }
  location ^~ /admin/ { proxy_pass http://127.0.0.1:4001; }
  location ^~ /admin/_next/ { proxy_pass http://127.0.0.1:4001; }
  location ~ ^/_next/static/(css|chunks)/app/(payload)/ { proxy_pass http://127.0.0.1:4001; }
  location ~ ^/_next/static/media/payload- { proxy_pass http://127.0.0.1:4001; }

  location /api/ {
    proxy_pass http://127.0.0.1:4001;
  }

  # Next.js static assets (hashed) – pass through without HTML no-store headers (dev)
  location ^~ /_next/ {
    proxy_pass http://127.0.0.1:4000;
  }

  location / {
    proxy_pass http://127.0.0.1:4000/;
    # Do not cache HTML/doc responses; let hashed assets under /_next/ use upstream caching (dev)
    add_header Cache-Control "private, no-store, must-revalidate" always;
  }
}

# Fallback / unknown host block (optional) -> 400 or redirect apex
server {
  listen 80 default_server;
  server_name _;
  # Provide healthz without requiring Host header so local curl succeeds
  location = /healthz { return 200 'ok'; add_header Content-Type text/plain; }
  return 301 http://bbaysinger.com$request_uri;
}

# SSL PROD SERVER BLOCK
server {
  listen 443 ssl;
  http2 on;
  server_name bbaysinger.com www.bbaysinger.com;

  # SSL prod image handling
  location ~* \.(?:png|jpe?g|gif|webp|svg|avif)$ {
    try_files $uri $uri/ =404;
    error_page 404 = @empty_image_404_ssl_prod;
    access_log off;
    add_header Cache-Control "public, max-age=3600";
  }
  location @empty_image_404_ssl_prod { return 404 ""; }
  ssl_certificate     /etc/letsencrypt/live/bbaysinger.com/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/bbaysinger.com/privkey.pem;
  include /etc/letsencrypt/options-ssl-nginx.conf;

  location = /healthz { return 200 'ok'; add_header Content-Type text/plain; }

  # Admin UI and assets → Backend (Prod SSL)
  # Normalize bare /admin to trailing-slash to satisfy Next trailingSlash=true
  location = /admin { return 308 /admin/; }
  location ^~ /admin/ { proxy_pass http://127.0.0.1:3001; }
  location ^~ /admin/_next/ { proxy_pass http://127.0.0.1:3001; }
  location ~ ^/_next/static/(css|chunks)/app/(payload)/ { proxy_pass http://127.0.0.1:3001; }
  location ~ ^/_next/static/media/payload- { proxy_pass http://127.0.0.1:3001; }

  location /api/ {
    proxy_pass http://127.0.0.1:3001;
  }

  # Next.js static assets (hashed) – pass through without HTML no-store headers (SSL)
  location ^~ /_next/ {
    proxy_pass http://127.0.0.1:3000;
  }

  location / {
    proxy_pass http://127.0.0.1:3000/;
    # Do not cache HTML/doc responses; let hashed assets under /_next/ use upstream caching (SSL)
    add_header Cache-Control "private, no-store, must-revalidate" always;
  }
}

# SSL DEV SERVER BLOCK
server {
  listen 443 ssl;
  http2 on;
  server_name dev.bbaysinger.com;

  # SSL dev image handling
  location ~* \.(?:png|jpe?g|gif|webp|svg|avif)$ {
    try_files $uri $uri/ =404;
    error_page 404 = @empty_image_404_ssl_dev;
    access_log off;
    add_header Cache-Control "public, max-age=60";
  }
  location @empty_image_404_ssl_dev { return 404 ""; }
  ssl_certificate     /etc/letsencrypt/live/bbaysinger.com/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/bbaysinger.com/privkey.pem;
  include /etc/letsencrypt/options-ssl-nginx.conf;

  location = /healthz { return 200 'ok'; add_header Content-Type text/plain; }

  # Admin UI and assets → Backend (Dev SSL)
  # Normalize bare /admin to trailing-slash to satisfy Next trailingSlash=true
  location = /admin { return 308 /admin/; }
  location ^~ /admin/ { proxy_pass http://127.0.0.1:4001; }
  location ^~ /admin/_next/ { proxy_pass http://127.0.0.1:4001; }
  location ~ ^/_next/static/(css|chunks)/app/(payload)/ { proxy_pass http://127.0.0.1:4001; }
  location ~ ^/_next/static/media/payload- { proxy_pass http://127.0.0.1:4001; }

  location /api/ {
    proxy_pass http://127.0.0.1:4001;
  }

  # Next.js static assets (hashed) – pass through without HTML no-store headers (dev SSL)
  location ^~ /_next/ {
    proxy_pass http://127.0.0.1:4000;
  }

  location / {
    proxy_pass http://127.0.0.1:4000/;
    # Do not cache HTML/doc responses; let hashed assets under /_next/ use upstream caching (dev SSL)
    add_header Cache-Control "private, no-store, must-revalidate" always;
  }
}

