# Unified Nginx reverse proxy config for bb-portfolio
# Copy to /etc/nginx/conf.d/bb-portfolio.conf on the EC2 host then: nginx -t && systemctl reload nginx
# Domains:
#   Production: bbaysinger.com, www.bbaysinger.com
#   Development: dev.bbaysinger.com
# Upstreams (container host ports):
#   Prod Frontend  : 3000
#   Prod Backend   : 3001
#   Dev Frontend   : 4000
#   Dev Backend    : 4001
# Health endpoints:
#   /api/health/ (backend) and /healthz (static) for quick probes.

include /etc/nginx/mime.types; # restore MIME mappings to avoid text/plain for JS/CSS
map $http_upgrade $connection_upgrade { default upgrade; '' close; }

# Shared proxy settings (global nginx.conf already sets types_hash_max_size)
# Avoid duplicating global tunables here to prevent reload failures.
proxy_http_version 1.1;
proxy_set_header X-Real-IP $remote_addr;
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
proxy_set_header X-Forwarded-Proto $scheme;
proxy_set_header Host $host;
proxy_set_header Upgrade $http_upgrade;
proxy_set_header Connection $connection_upgrade;
proxy_read_timeout 60s;

# PROD SERVER BLOCK
server {
  listen 80;
  server_name bbaysinger.com www.bbaysinger.com;


  # Static emergency health
  location = /healthz { return 200 'ok'; add_header Content-Type text/plain; }

  # Admin UI and assets → Backend (Prod)
  # Normalize bare /admin to trailing-slash to satisfy Next trailingSlash=true
  location = /admin { return 308 /admin/; }
  location ^~ /admin/ { proxy_pass http://127.0.0.1:3001; }
  # Admin assets may be requested under /admin/_next/* when older builds are cached.
  # Provide a safe fallback to /_next/* in case the backend still serves there.
  location ^~ /admin/_next/ {
    proxy_intercept_errors on;
    error_page 404 = @admin_next_fallback;
    proxy_pass http://127.0.0.1:3001;
  }
  location @admin_next_fallback {
    rewrite ^/admin/_next/(.*)$ /_next/$1 break;
    proxy_pass http://127.0.0.1:3001;
  }
  # Payload/Next admin-specific static emitted under root _next (defensive)
  location ~ ^/_next/static/(css|chunks)/app/(payload)/ { proxy_pass http://127.0.0.1:3001; }
  location ~ ^/_next/static/media/payload- { proxy_pass http://127.0.0.1:3001; }

  # Backend API (Prod)
  location /api/ {
    # Preserve /api prefix (no trailing slash on upstream) so /api/health stays /api/health
    proxy_pass http://127.0.0.1:3001;
  }

  # Next.js static assets (hashed) – pass through without HTML no-store headers
  location ^~ /_next/ {
    proxy_pass http://127.0.0.1:3000;
  }

  # Everything else → Frontend (Prod)
  location / {
    proxy_pass http://127.0.0.1:3000/;
    # Do not cache HTML/doc responses; let hashed assets under /_next/ use upstream caching
    add_header Cache-Control "private, no-store, must-revalidate" always;
  }
}

# DEV SERVER BLOCK
server {
  listen 80;
  server_name dev.bbaysinger.com;


  location = /healthz { return 200 'ok'; add_header Content-Type text/plain; }

  # Admin UI and assets → Backend (Dev)
  # Normalize bare /admin to trailing-slash to satisfy Next trailingSlash=true
  location = /admin { return 308 /admin/; }
  location ^~ /admin/ { proxy_pass http://127.0.0.1:4001; }
  
  # Admin assets - serve with fallback to /_next/* if needed (dev)
  location ^~ /admin/_next/ {
    proxy_intercept_errors on;
    error_page 404 = @admin_next_fallback_dev;
    proxy_pass http://127.0.0.1:4001;
  }
  location @admin_next_fallback_dev {
    rewrite ^/admin/_next/(.*)$ /_next/$1 break;
    proxy_pass http://127.0.0.1:4001;
  }
  location ~ ^/_next/static/(css|chunks)/app/(payload)/ { proxy_pass http://127.0.0.1:4001; }
  location ~ ^/_next/static/media/payload- { proxy_pass http://127.0.0.1:4001; }

  location /api/ {
    proxy_pass http://127.0.0.1:4001;
  }

  # Next.js static assets (hashed) – pass through without HTML no-store headers (dev)
  location ^~ /_next/ {
    proxy_pass http://127.0.0.1:4000;
  }

  location / {
    proxy_pass http://127.0.0.1:4000/;
    # Do not cache HTML/doc responses; let hashed assets under /_next/ use upstream caching (dev)
    add_header Cache-Control "private, no-store, must-revalidate" always;
  }
}

# Fallback / unknown host block (optional) -> 400 or redirect apex
server {
  listen 80 default_server;
  server_name _;
  # Provide healthz without requiring Host header so local curl succeeds
  location = /healthz { return 200 'ok'; add_header Content-Type text/plain; }
  return 301 http://bbaysinger.com$request_uri;
}

# SSL PROD SERVER BLOCK
server {
  listen 443 ssl;
  http2 on;
  server_name bbaysinger.com www.bbaysinger.com;

  ssl_certificate     /etc/letsencrypt/live/bbaysinger.com/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/bbaysinger.com/privkey.pem;
  include /etc/letsencrypt/options-ssl-nginx.conf;

  location = /healthz { return 200 'ok'; add_header Content-Type text/plain; }

  # Admin UI and assets → Backend (Prod SSL)
  # Normalize bare /admin to trailing-slash to satisfy Next trailingSlash=true
  location = /admin { return 308 /admin/; }
  location ^~ /admin/ { proxy_pass http://127.0.0.1:3001; }
  
  # Admin assets - serve with fallback to /_next/* if needed (SSL)
  location ^~ /admin/_next/ {
    proxy_intercept_errors on;
    error_page 404 = @admin_next_fallback_ssl;
    proxy_pass http://127.0.0.1:3001;
  }
  location @admin_next_fallback_ssl {
    rewrite ^/admin/_next/(.*)$ /_next/$1 break;
    proxy_pass http://127.0.0.1:3001;
  }
  location ~ ^/_next/static/(css|chunks)/app/(payload)/ { proxy_pass http://127.0.0.1:3001; }
  location ~ ^/_next/static/media/payload- { proxy_pass http://127.0.0.1:3001; }

  location /api/ {
    proxy_pass http://127.0.0.1:3001;
  }

  # Next.js static assets (hashed) – pass through without HTML no-store headers (SSL)
  location ^~ /_next/ {
    proxy_pass http://127.0.0.1:3000;
  }

  location / {
    proxy_pass http://127.0.0.1:3000/;
    # Do not cache HTML/doc responses; let hashed assets under /_next/ use upstream caching (SSL)
    add_header Cache-Control "private, no-store, must-revalidate" always;
  }
}

# SSL DEV SERVER BLOCK
server {
  listen 443 ssl;
  http2 on;
  server_name dev.bbaysinger.com;

  ssl_certificate     /etc/letsencrypt/live/bbaysinger.com/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/bbaysinger.com/privkey.pem;
  include /etc/letsencrypt/options-ssl-nginx.conf;

  location = /healthz { return 200 'ok'; add_header Content-Type text/plain; }

  # Admin UI and assets → Backend (Dev SSL)
  # Normalize bare /admin to trailing-slash to satisfy Next trailingSlash=true
  location = /admin { return 308 /admin/; }
  location ^~ /admin/ { proxy_pass http://127.0.0.1:4001; }
  
  # Admin assets - serve with fallback to /_next/* if needed (dev SSL)
  location ^~ /admin/_next/ {
    proxy_intercept_errors on;
    error_page 404 = @admin_next_fallback_dev_ssl;
    proxy_pass http://127.0.0.1:4001;
  }
  location @admin_next_fallback_dev_ssl {
    rewrite ^/admin/_next/(.*)$ /_next/$1 break;
    proxy_pass http://127.0.0.1:4001;
  }
  location ~ ^/_next/static/(css|chunks)/app/(payload)/ { proxy_pass http://127.0.0.1:4001; }
  location ~ ^/_next/static/media/payload- { proxy_pass http://127.0.0.1:4001; }

  location /api/ {
    proxy_pass http://127.0.0.1:4001;
  }

  # Next.js static assets (hashed) – pass through without HTML no-store headers (dev SSL)
  location ^~ /_next/ {
    proxy_pass http://127.0.0.1:4000;
  }

  location / {
    proxy_pass http://127.0.0.1:4000/;
    # Do not cache HTML/doc responses; let hashed assets under /_next/ use upstream caching (dev SSL)
    add_header Cache-Control "private, no-store, must-revalidate" always;
  }
}

