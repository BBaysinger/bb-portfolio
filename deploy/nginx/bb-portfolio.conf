# Unified Nginx reverse proxy config for bb-portfolio
# Copy to /etc/nginx/conf.d/bb-portfolio.conf on the EC2 host then: nginx -t && systemctl reload nginx
# Domains:
#   Configure server_name values to match your domain(s).
#   If you don't have a domain yet, the prod block below is a default_server and
#   will serve traffic by IP/any Host header.
# Upstreams (container host ports):
#   Prod Frontend  : 3000
#   Prod Backend   : 3001
#   Dev Frontend   : 4000
#   Dev Backend    : 4001
# Health endpoints:
#   /api/health/ (backend) and /healthz (static) for quick probes.

include /etc/nginx/mime.types; # restore MIME mappings to avoid text/plain for JS/CSS
map $http_upgrade $connection_upgrade { default upgrade; '' close; }

# Shared proxy settings (global nginx.conf already sets types_hash_max_size)
# Avoid duplicating global tunables here to prevent reload failures.
proxy_http_version 1.1;
proxy_set_header X-Real-IP $remote_addr;
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
proxy_set_header X-Forwarded-Proto $scheme;
proxy_set_header Host $host;
proxy_set_header Upgrade $http_upgrade;
proxy_set_header Connection $connection_upgrade;
proxy_read_timeout 60s;

# PROD SERVER BLOCK
server {
  listen 80 default_server;
  server_name _;

  # Static emergency health (keep HTTP for probes)
  location = /healthz { return 200 'ok'; add_header Content-Type text/plain; }

  # Allow ACME challenges over HTTP during initial HTTPS issuance.
  location ^~ /.well-known/acme-challenge/ { root /var/www/html; }

  location /api/ { proxy_pass http://127.0.0.1:3001; }
  location / { proxy_pass http://127.0.0.1:3000/; }
}

# DEV SERVER BLOCK
server {
  listen 80;
  server_name dev.bbaysinger.com;

  # Static emergency health (keep HTTP for probes)
  location = /healthz { return 200 'ok'; add_header Content-Type text/plain; }

  # Allow ACME challenges over HTTP during initial HTTPS issuance.
  location ^~ /.well-known/acme-challenge/ { root /var/www/html; }

  location /api/ { proxy_pass http://127.0.0.1:4001; }
  location / { proxy_pass http://127.0.0.1:4000/; }
}

