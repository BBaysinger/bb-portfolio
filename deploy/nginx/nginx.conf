events {
    worker_connections 1024;
}

http {
    # Normalize Connection header based on Upgrade so we don't unconditionally
    # send "upgrade" to upstreams (breaks some SSR fetches)
    map $http_upgrade $connection_upgrade {
        default upgrade;
        ""      close;
    }
    # Basic settings
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;

    # MIME types
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # Logging
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

    # ---- Rate limiting & proxy tuning (hardening) ----
    # Zones: store per-IP counters. Adjust sizes/rates after observing traffic.
    limit_req_zone $binary_remote_addr zone=api_limit:10m rate=30r/m;    # API: 30 req/min/IP
    limit_req_zone $binary_remote_addr zone=admin_limit:10m rate=15r/m;  # Admin: 15 req/min/IP

    # Proxy timeouts (reduce long hangs) & buffering (mitigate temp file spills)
    proxy_connect_timeout 5s;
    proxy_read_timeout 60s;
    proxy_send_timeout 60s;
    proxy_buffer_size 16k;
    proxy_buffers 8 16k;
    proxy_busy_buffers_size 64k;
    proxy_max_temp_file_size 0; # avoid writing large responses to disk temp files

    # Decide which app should serve Next static assets (/ _next/*)
    # LOCAL map (Mac): frontend on 3000, backend on 8081
    map $http_referer $next_static_upstream_local {
        # Default to frontend (public site)
        default                             http://127.0.0.1:3000;
        # If Referer indicates Admin (/admin), serve from backend
        ~*"/admin(/|$|.*)"                 http://127.0.0.1:8081;
    }

    # PROD map (EC2): frontend on 3000, backend on 3001
    map $http_referer $next_static_upstream_prod {
        # Default to frontend (public site)
        default                             http://127.0.0.1:3000;
        # If Referer indicates Admin (/admin), serve from backend
        ~*/admin(/|$|.*)                   http://127.0.0.1:3001;
    }

    # Alternate upstream for PROD to enable 404 fallback
    map $http_referer $next_static_alt_upstream_prod {
        # If primary is frontend, fallback to backend
        default                             http://127.0.0.1:3001;
        # If primary is backend (admin), fallback to frontend
        ~*/admin(/|$|.*)                   http://127.0.0.1:3000;
    }

    # DEV map (EC2): frontend on 4000, backend on 4001
    map $http_referer $next_static_upstream_dev {
        # Default to frontend (public site)
        default                             http://127.0.0.1:4000;
        # If Referer indicates Admin (/admin), serve from backend
        ~*/admin(/|$|.*)                   http://127.0.0.1:4001;
    }

    # Alternate upstream for DEV to enable 404 fallback
    map $http_referer $next_static_alt_upstream_dev {
        # If primary is frontend, fallback to backend
        default                             http://127.0.0.1:4001;
        # If primary is backend (admin), fallback to frontend
        ~*/admin(/|$|.*)                   http://127.0.0.1:4000;
    }

    # Local development server block (mirrors production setup)
    # Default catch-all for unmatched hosts (e.g., raw IP) — redirect to primary domain
    # This prevents ambiguous behavior like "Empty reply from server" when curling 127.0.0.1
    server {
        listen 80 default_server;
        server_name _;
        return 301 http://bbaysinger.com$request_uri;
    }

    # Local development server block (mirrors production setup)
    server {
        listen 80;
    server_name localhost;

        # Admin interface proxy to local backend
        location /admin {
            proxy_pass http://127.0.0.1:8081/admin;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
        }

        # Admin assets (assetPrefix) — always from backend
        # This matches when backend Next.js emits /admin/_next/* assets
        location ^~ /admin/_next/ {
            proxy_pass http://127.0.0.1:8081;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }

        # Admin-specific Next static assets (path-based) — always from backend
        location ~ ^/_next/static/(css|chunks)/app/(payload)/ {
            proxy_pass http://127.0.0.1:8081;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }
        location ~ ^/_next/static/media/payload- {
            proxy_pass http://127.0.0.1:8081;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }

        # Next.js static chunks (both apps use /_next/*). Route based on Referer.
        location /_next/ {
            proxy_pass $next_static_upstream_local;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }

        # API proxy to local backend
        location /api/ {
            proxy_pass http://127.0.0.1:8081/api/;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Frontend proxy to local frontend - MUST be last
        location / {
            # Upstream Host override ensures SSR fetches use the container host
            proxy_set_header Host 127.0.0.1:3000;
            proxy_pass http://127.0.0.1:3000;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            # Preserve original host for app logic and absolute URLs
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }
    }

    # Production server block (EC2)
    # Replace example.com with your production domain/hostname.
    # Frontend exposed on 3000, Backend exposed on 3001 (see compose prod profile)
    server {
        listen 80;
        # IMPORTANT: Use your actual prod hostname(s)
    server_name bbaysinger.com www.bbaysinger.com;
    add_header Strict-Transport-Security "max-age=86400; includeSubDomains" always;

        # Normalize /admin (no trailing slash) -> /admin/
        location = /admin {
            return 301 /admin/;
        }

        # Admin interface and all subpaths to backend (explicit, no URI in proxy_pass)
        # Using ^~ ensures this wins over regex locations
        location ^~ /admin/ {
            # Rate limit admin interface to mitigate brute-force/scraping
            limit_req zone=admin_limit burst=5 nodelay;
            proxy_pass http://127.0.0.1:3001;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
        }

        # Admin assets (assetPrefix) — always from backend
        # This matches when backend Next.js emits /admin/_next/* assets
        location ^~ /admin/_next/ {
            proxy_pass http://127.0.0.1:3001;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }

        # Admin-specific Next static assets (path-based) — always from backend
        location ~ ^/_next/static/(css|chunks)/app/(payload)/ {
            proxy_pass http://127.0.0.1:3001;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }
        location ~ ^/_next/static/media/payload- {
            proxy_pass http://127.0.0.1:3001;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }

        # Next.js static chunks - route based on Referer (prod map)
        location /_next/ {
            proxy_intercept_errors on; # allow fallback on 404
            add_header X-Next-Upstream $next_static_upstream_prod always;
            error_page 404 = @next_fallback_prod;
            proxy_pass $next_static_upstream_prod;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }

        # If a /_next/* asset 404s on primary, try the alternate app
        location @next_fallback_prod {
            add_header X-Next-Upstream $next_static_alt_upstream_prod always;
            proxy_pass $next_static_alt_upstream_prod;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }

        # API proxy to backend (prod)
        location /api/ {
            # Rate limit API requests per IP
            limit_req zone=api_limit burst=10 nodelay;
            proxy_pass http://127.0.0.1:3001/api/;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Frontend proxy to frontend (prod) - MUST be last
        location / {
            # Upstream Host override ensures SSR fetches use the container host
            proxy_set_header Host 127.0.0.1:3000;
            proxy_pass http://127.0.0.1:3000;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            # Preserve original host for app logic and absolute URLs
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }
    }

    # Development server block (EC2 sandbox)
    # Replace dev.example.com with your dev hostname.
    # Frontend exposed on 4000, Backend exposed on 4001 (see compose dev profile)
    server {
        listen 80;
    server_name dev.bbaysinger.com;
    add_header Strict-Transport-Security "max-age=86400; includeSubDomains" always;

        # Normalize /admin (no trailing slash) -> /admin/
        location = /admin {
            return 301 /admin/;
        }

        # Admin interface and all subpaths to backend (explicit, no URI in proxy_pass)
        location ^~ /admin/ {
            # Dev admin rate limit (adjust independently if needed)
            limit_req zone=admin_limit burst=5 nodelay;
            proxy_pass http://127.0.0.1:4001;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
        }

        # Admin assets (assetPrefix) — always from backend
        # This matches when backend Next.js emits /admin/_next/* assets
        location ^~ /admin/_next/ {
            proxy_pass http://127.0.0.1:4001;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }

        # Admin-specific Next static assets (path-based) — always from backend
        location ~ ^/_next/static/(css|chunks)/app/(payload)/ {
            proxy_pass http://127.0.0.1:4001;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }
        location ~ ^/_next/static/media/payload- {
            proxy_pass http://127.0.0.1:4001;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }

        # Next.js static chunks - route based on Referer (dev map)
        location /_next/ {
            proxy_intercept_errors on; # allow fallback on 404
            add_header X-Next-Upstream $next_static_upstream_dev always;
            error_page 404 = @next_fallback_dev;
            proxy_pass $next_static_upstream_dev;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }

        # If a /_next/* asset 404s on primary, try the alternate app
        location @next_fallback_dev {
            add_header X-Next-Upstream $next_static_alt_upstream_dev always;
            proxy_pass $next_static_alt_upstream_dev;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }

        # API proxy to backend (dev)
        location /api/ {
            # Dev API rate limit
            limit_req zone=api_limit burst=10 nodelay;
            proxy_pass http://127.0.0.1:4001/api/;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Frontend proxy to frontend (dev) - MUST be last
        location / {
            # Upstream Host override ensures SSR fetches use the container host
            proxy_set_header Host 127.0.0.1:4000;
            proxy_pass http://127.0.0.1:4000;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            # Preserve original host for app logic and absolute URLs
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }
    }
}