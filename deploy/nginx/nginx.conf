events {
    worker_connections 1024;
}

http {
    # Basic settings
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;

    # MIME types
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # Logging
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

    # Decide which app should serve Next static assets (/ _next/*)
    # LOCAL map (Mac): frontend on 3000, backend on 8081
    map $http_referer $next_static_upstream_local {
        # Default to frontend (public site)
        default                             http://127.0.0.1:3000;
        # If Referer indicates Admin (/admin), serve from backend
        ~*"/admin(/|$|.*)"                 http://127.0.0.1:8081;
    }

    # PROD map (EC2): frontend on 3000, backend on 3001
    map $http_referer $next_static_upstream_prod {
        # Default to frontend (public site)
        default                             http://127.0.0.1:3000;
        # If Referer indicates Admin (/admin), serve from backend
        ~*/admin(/|$|.*)                   http://127.0.0.1:3001;
    }

    # Alternate upstream for PROD to enable 404 fallback
    map $http_referer $next_static_alt_upstream_prod {
        # If primary is frontend, fallback to backend
        default                             http://127.0.0.1:3001;
        # If primary is backend (admin), fallback to frontend
        ~*/admin(/|$|.*)                   http://127.0.0.1:3000;
    }

    # DEV map (EC2): frontend on 4000, backend on 4001
    map $http_referer $next_static_upstream_dev {
        # Default to frontend (public site)
        default                             http://127.0.0.1:4000;
        # If Referer indicates Admin (/admin), serve from backend
        ~*/admin(/|$|.*)                   http://127.0.0.1:4001;
    }

    # Alternate upstream for DEV to enable 404 fallback
    map $http_referer $next_static_alt_upstream_dev {
        # If primary is frontend, fallback to backend
        default                             http://127.0.0.1:4001;
        # If primary is backend (admin), fallback to frontend
        ~*/admin(/|$|.*)                   http://127.0.0.1:4000;
    }

    # Local development server block (mirrors production setup)
    server {
        listen 80;
        server_name localhost local.bbinteractive.io;

        # Admin interface proxy to local backend
        location /admin {
            proxy_pass http://127.0.0.1:8081/admin;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
        }

        # Admin-specific Next static assets (path-based) — always from backend
        location ~ ^/_next/static/(css|chunks)/app/(payload)/ {
            proxy_pass http://127.0.0.1:8081;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }
        location ~ ^/_next/static/media/payload- {
            proxy_pass http://127.0.0.1:8081;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }

        # Next.js static chunks (both apps use /_next/*). Route based on Referer.
        location /_next/ {
            proxy_pass $next_static_upstream_local;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }

        # API proxy to local backend
        location /api/ {
            proxy_pass http://127.0.0.1:8081/api/;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Frontend proxy to local frontend - MUST be last
        location / {
            proxy_pass http://127.0.0.1:3000;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }
    }

    # Production server block (EC2)
    # Replace example.com with your production domain/hostname.
    # Frontend exposed on 3000, Backend exposed on 3001 (see compose prod profile)
    server {
        listen 80;
        # IMPORTANT: Use your actual prod hostname(s)
        server_name bbinteractive.io www.bbinteractive.io;

        # Admin interface proxy to backend (prod)
        location /admin {
            proxy_pass http://127.0.0.1:3001/admin;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
        }

        # Admin-specific Next static assets (path-based) — always from backend
        location ~ ^/_next/static/(css|chunks)/app/(payload)/ {
            proxy_pass http://127.0.0.1:3001;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }
        location ~ ^/_next/static/media/payload- {
            proxy_pass http://127.0.0.1:3001;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }

        # Next.js static chunks - route based on Referer (prod map)
        location /_next/ {
            proxy_intercept_errors on; # allow fallback on 404
            add_header X-Next-Upstream $next_static_upstream_prod always;
            error_page 404 = @next_fallback_prod;
            proxy_pass $next_static_upstream_prod;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }

        # If a /_next/* asset 404s on primary, try the alternate app
        location @next_fallback_prod {
            add_header X-Next-Upstream $next_static_alt_upstream_prod always;
            proxy_pass $next_static_alt_upstream_prod;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }

        # API proxy to backend (prod)
        location /api/ {
            proxy_pass http://127.0.0.1:3001/api/;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Frontend proxy to frontend (prod) - MUST be last
        location / {
            proxy_pass http://127.0.0.1:3000;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }
    }

    # Development server block (EC2 sandbox)
    # Replace dev.example.com with your dev hostname.
    # Frontend exposed on 4000, Backend exposed on 4001 (see compose dev profile)
    server {
        listen 80;
        server_name dev.bbinteractive.io;

        # Admin interface proxy to backend (dev)
        location /admin {
            proxy_pass http://127.0.0.1:4001/admin;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
        }

        # Admin-specific Next static assets (path-based) — always from backend
        location ~ ^/_next/static/(css|chunks)/app/(payload)/ {
            proxy_pass http://127.0.0.1:4001;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }
        location ~ ^/_next/static/media/payload- {
            proxy_pass http://127.0.0.1:4001;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }

        # Next.js static chunks - route based on Referer (dev map)
        location /_next/ {
            proxy_intercept_errors on; # allow fallback on 404
            add_header X-Next-Upstream $next_static_upstream_dev always;
            error_page 404 = @next_fallback_dev;
            proxy_pass $next_static_upstream_dev;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }

        # If a /_next/* asset 404s on primary, try the alternate app
        location @next_fallback_dev {
            add_header X-Next-Upstream $next_static_alt_upstream_dev always;
            proxy_pass $next_static_alt_upstream_dev;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }

        # API proxy to backend (dev)
        location /api/ {
            proxy_pass http://127.0.0.1:4001/api/;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Frontend proxy to frontend (dev) - MUST be last
        location / {
            proxy_pass http://127.0.0.1:4000;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }
    }
}