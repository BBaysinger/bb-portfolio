# =============================================================================
# CI/CD Pipeline - BB Portfolio Site
# =============================================================================
#
# This workflow provides automated build, test, and deployment for the
# portfolio application with support for multiple environments:
#
# TRIGGERS:
# - Push to 'main' branch: Full CI/CD with production deployment
# - Push to 'dev' branch: CI/CD with development environment rebuild
# - Manual dispatch: Allows manual triggering for any branch
#
# JOBS:
# 1. build-and-test: Validates code quality and builds both frontend/backend
# 2. deploy-prod: Deploys to AWS EC2 production (main branch only)
# 3. rebuild-dev: Rebuilds development environment (dev branch or manual)
#
# DEPLOYMENT TARGETS:
# - Production: Uses pre-built ECR images for fast, reliable deployments
# - Development: Builds directly on EC2 for flexibility and testing
# =============================================================================

name: CI/CD Pipeline

# Workflow triggers
on:
  push:
    branches:
      - main # Production deployments
      - dev # Development environment rebuilds
  workflow_dispatch: # Manual trigger for any branch

jobs:
  # ==========================================================================
  # BUILD AND TEST JOB
  # ==========================================================================
  # Validates code quality, runs tests, and ensures both frontend and backend
  # can be built successfully before any deployment occurs
  # ==========================================================================
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      # Checkout source code
      - name: Checkout code
        uses: actions/checkout@v4

      # Setup Node.js environment
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20 # LTS version for stability

      # =======================================================================
      # FRONTEND BUILD AND TEST
      # =======================================================================
      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm install --legacy-peer-deps # Required for some peer dependency conflicts

      - name: Build frontend
        working-directory: ./frontend
        run: npm run build # Next.js production build

      - name: Test frontend
        working-directory: ./frontend
        run: npm test || echo "âš ï¸ No frontend tests yet" # Graceful failure until tests are implemented

      # =======================================================================
      # BACKEND BUILD AND TEST
      # =======================================================================
      - name: Install backend dependencies
        working-directory: ./backend
        run: npm install --legacy-peer-deps # Required for some peer dependency conflicts

      - name: Build backend
        working-directory: ./backend
        run: npm run build # Next.js production build (Payload CMS)

      - name: Test backend
        working-directory: ./backend
        run: npm test || echo "âš ï¸ No backend tests yet" # Graceful failure until tests are implemented

  # ==========================================================================
  # PRODUCTION DEPLOYMENT JOB
  # ==========================================================================
  # Deploys to AWS EC2 production environment using pre-built ECR images
  # Only runs on main branch pushes after successful build and test
  # ==========================================================================
  deploy-prod:
    if: github.ref == 'refs/heads/main' # Production deploys only from main branch
    needs: build-and-test # Wait for successful build and test
    runs-on: ubuntu-latest
    timeout-minutes: 15 # Extended timeout for deployment operations

    steps:
      # Checkout source code for docker-compose.yml and deployment scripts
      - name: Checkout code
        uses: actions/checkout@v4

      # =======================================================================
      # AWS AUTHENTICATION AND ECR LOGIN
      # =======================================================================
      # Configure AWS credentials for ECR access and deployment operations
      # =======================================================================
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-west-2 # Oregon region for EC2 and ECR resources

      # Login to Amazon ECR using AWS CLI authentication
      - name: Login to Amazon ECR
        run: |
          echo "ðŸ” Authenticating with Amazon ECR..."
          aws ecr get-login-password --region us-west-2 \
            | docker login --username AWS --password-stdin 778230822028.dkr.ecr.us-west-2.amazonaws.com

      # =======================================================================
      # DOCKER IMAGE BUILD AND PUSH TO ECR
      # =======================================================================
      # Build production-optimized images and push to ECR registry
      # Uses 'latest' tag for simplicity and fast deployment
      # =======================================================================
      - name: Build and push frontend-prod
        run: |
          echo "ðŸ—ï¸ Building frontend production image..."
          docker build -t frontend:latest ./frontend
          echo "ðŸ·ï¸ Tagging frontend image for ECR..."
          docker tag frontend:latest 778230822028.dkr.ecr.us-west-2.amazonaws.com/portfolio/frontend:latest
          echo "ðŸ“¤ Pushing frontend image to ECR..."
          docker push 778230822028.dkr.ecr.us-west-2.amazonaws.com/portfolio/frontend:latest
          echo "âœ… Frontend image push complete"

      - name: Build and push backend-prod
        run: |
          echo "ðŸ—ï¸ Building backend production image..."
          docker build -t backend:latest ./backend
          echo "ðŸ·ï¸ Tagging backend image for ECR..."
          docker tag backend:latest 778230822028.dkr.ecr.us-west-2.amazonaws.com/portfolio/backend:latest
          echo "ðŸ“¤ Pushing backend image to ECR..."
          docker push 778230822028.dkr.ecr.us-west-2.amazonaws.com/portfolio/backend:latest
          echo "âœ… Backend image push complete"

      # =======================================================================
      # EC2 PRODUCTION DEPLOYMENT
      # =======================================================================
      # Deploy to production EC2 instance using SSH automation
      # Handles Docker/AWS CLI installation and zero-downtime deployment
      # =======================================================================
      - name: Deploy prod on EC2
        uses: appleboy/ssh-action@v1.0.3
        timeout-minutes: 15 # Extended timeout for Docker installation and health checks
        with:
          host: ${{ secrets.EC2_HOST }} # EC2 public IP address
          username: ec2-user # Default Amazon Linux user
          key: ${{ secrets.EC2_SSH_KEY }} # SSH private key for authentication
          command_timeout: 12m # Extended SSH command timeout
          script: |
            echo "ðŸš€ Starting production deployment at $(date)"
            echo "ðŸ“ Deploying to: $(hostname)"

            # ===============================================================
            # INFRASTRUCTURE SETUP
            # ===============================================================
            # Install required tools if not present on EC2 instance
            # ===============================================================

            # Install Docker if not present
            if ! command -v docker &> /dev/null; then
              echo "ðŸ“¦ Installing Docker..."
              sudo yum update -y
              sudo yum install -y docker
              sudo systemctl start docker
              sudo systemctl enable docker
              sudo usermod -a -G docker ec2-user
              echo "âœ… Docker installation complete"
            else
              echo "âœ… Docker already installed"
            fi

            # Install AWS CLI if not present (required for ECR authentication)
            if ! command -v aws &> /dev/null; then
              echo "ðŸ“¦ Installing AWS CLI..."
              sudo yum install -y awscli
              echo "âœ… AWS CLI installation complete"
            else
              echo "âœ… AWS CLI already installed"
            fi

            # Install Docker Compose plugin if not present
            if ! docker compose version &> /dev/null; then
              echo "ðŸ“¦ Installing Docker Compose..."
              sudo mkdir -p /usr/local/lib/docker/cli-plugins
              sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/lib/docker/cli-plugins/docker-compose
              sudo chmod +x /usr/local/lib/docker/cli-plugins/docker-compose
              echo "âœ… Docker Compose installation complete"
            else
              echo "âœ… Docker Compose already installed"
            fi

            # ===============================================================
            # DOCKER SERVICE PREPARATION
            # ===============================================================
            # Ensure Docker daemon is running and accessible
            # ===============================================================
            echo "ðŸ”§ Preparing Docker service..."
            sudo systemctl daemon-reload
            sudo systemctl start docker
            sudo systemctl enable docker
            sleep 5  # Wait for Docker daemon to be fully ready
            sudo docker --version  # Verify Docker is working

            # ===============================================================
            # AWS AUTHENTICATION SETUP
            # ===============================================================
            # Configure AWS credentials for ECR access from EC2
            # ===============================================================
            echo "ðŸ” Configuring AWS credentials..."
            aws configure set aws_access_key_id ${{ secrets.AWS_ACCESS_KEY_ID }}
            aws configure set aws_secret_access_key ${{ secrets.AWS_SECRET_ACCESS_KEY }}
            aws configure set default.region us-west-2

            # ECR login for both sudo and regular user contexts
            echo "ðŸ” Authenticating with ECR..."
            aws ecr get-login-password --region us-west-2 | sudo docker login --username AWS --password-stdin 778230822028.dkr.ecr.us-west-2.amazonaws.com
            aws ecr get-login-password --region us-west-2 | docker login --username AWS --password-stdin 778230822028.dkr.ecr.us-west-2.amazonaws.com

            # ===============================================================
            # REPOSITORY SETUP
            # ===============================================================
            # Clone or update project repository for docker-compose.yml
            # ===============================================================
            if ! command -v git &> /dev/null; then
              echo "ðŸ“¦ Installing Git..."
              sudo yum install -y git
            fi

            echo "ðŸ“¥ Setting up project repository..."
            cd $HOME
            if [ ! -d "portfolio" ]; then
              echo "ðŸ“¥ Cloning repository..."
              git clone https://github.com/BBaysinger/bb-portfolio.git portfolio
            else
              echo "ðŸ”„ Updating existing repository..."
              cd portfolio
              git fetch origin
              git checkout main
              git reset --hard origin/main
              cd ..
            fi

            # ===============================================================
            # ENVIRONMENT CONFIGURATION
            # ===============================================================
            # Create production environment files from GitHub secrets
            # ===============================================================
            cd ~/portfolio
            echo "âš™ï¸ Creating production environment files..."

            # Backend production environment
            cat > backend/.env.prod << EOF
            PORT=3000
            DATABASE_URI=${{ secrets.PROD_DATABASE_URI }}
            PAYLOAD_SECRET=${{ secrets.PROD_PAYLOAD_SECRET }}
            NODE_ENV=production
            EOF

            # Frontend production environment
            cat > frontend/.env.prod << EOF
            NODE_ENV=production
            NEXT_PUBLIC_API_URL=http://your-ec2-ip:4000
            EOF

            # ===============================================================
            # CONTAINER DEPLOYMENT
            # ===============================================================
            # Pull latest images and deploy with zero-downtime strategy
            # ===============================================================
            echo "â¬‡ï¸ Pulling latest production images..."
            COMPOSE_PROFILES=prod docker compose pull || {
              echo "âš ï¸ Failed to pull images. Continuing with existing images..."
            }

            # Deployment status check
            echo "ðŸ” Pre-deployment status check..."
            echo "ðŸ“Š System resources:"
            df -h | head -5  # Disk space
            free -h          # Memory usage
            echo "ðŸ“ Current user: $(whoami)"
            echo "ðŸ“ Working directory: $(pwd)"

            echo "ðŸš€ Starting production deployment..."
            COMPOSE_PROFILES=prod docker compose up -d

            # ===============================================================
            # HEALTH CHECKS AND VALIDATION
            # ===============================================================
            # Wait for containers to start and validate deployment
            # ===============================================================
            echo "â³ Waiting for containers to initialize..."
            sleep 20

            echo "ðŸ“‹ Checking container logs..."
            echo "=== Backend Container Logs ==="
            docker logs portfolio-backend-prod --tail 50 || echo "âš ï¸ Backend container not found"

            echo "=== Frontend Container Logs ==="
            docker logs portfolio-frontend-prod --tail 50 || echo "âš ï¸ Frontend container not found"

            echo "ðŸ“Š Final deployment status:"
            docker ps
            COMPOSE_PROFILES=prod docker compose ps

            echo "ðŸŽ‰ Production deployment complete at $(date)!"

  # ==========================================================================
  # DEVELOPMENT REBUILD JOB - SIMPLE EC2 BUILD
  # ==========================================================================
  # Rebuilds development environment directly on EC2 with hanging prevention
  # Triggered by pushes to 'dev' branch or manual workflow dispatch
  # ==========================================================================
  rebuild-dev:
    if: github.ref == 'refs/heads/dev' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - name: Deploy dev environment to EC2
        uses: appleboy/ssh-action@v1.0.3
        timeout-minutes: 20
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          command_timeout: 18m
          debug: true
          script: |
            echo "ï¿½ Starting development environment rebuild at $(date)"

            # Install Docker and dependencies if needed
            if ! command -v docker &> /dev/null; then
              echo "ðŸ“¦ Installing Docker..."
              sudo yum update -y && sudo yum install -y docker
              sudo systemctl start docker && sudo systemctl enable docker
              sudo usermod -a -G docker ec2-user
            fi

            if ! docker compose version &> /dev/null; then
              echo "ï¿½ Installing Docker Compose..."
              sudo mkdir -p /usr/local/lib/docker/cli-plugins
              sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/lib/docker/cli-plugins/docker-compose
              sudo chmod +x /usr/local/lib/docker/cli-plugins/docker-compose
            fi

            # Ensure Docker is running
            sudo systemctl start docker
            sleep 5

            # Update repository
            cd $HOME
            if [ ! -d "portfolio" ]; then
              git clone https://github.com/BBaysinger/bb-portfolio.git portfolio
            else
              cd portfolio && git fetch origin && git checkout dev && git reset --hard origin/dev && cd ..
            fi

            cd $HOME/portfolio

            # Create dev environment files
            cat > backend/.env.dev << EOF
            PORT=3000
            DATABASE_URI=${{ secrets.DEV_DATABASE_URI }}
            PAYLOAD_SECRET=${{ secrets.DEV_PAYLOAD_SECRET }}
            NODE_ENV=development
            EOF

            cat > frontend/.env.dev << EOF
            NODE_ENV=development
            NEXT_PUBLIC_API_URL=http://localhost:4000
            EOF

            # Clean up existing containers and resources
            echo "ðŸ§¹ Cleaning up existing containers..."
            COMPOSE_PROFILES=dev docker compose down --remove-orphans || echo "No existing containers"
            docker container prune -f || echo "Container cleanup done"
            docker image prune -f || echo "Image cleanup done"

            # Check system resources
            echo "ðŸ“Š System status before build:"
            echo "ðŸ’¾ Disk: $(df -h / | tail -1 | awk '{print $4}') available"
            echo "ðŸ§  Memory: $(free -h | grep Mem | awk '{print $7}') available"

            # Enable BuildKit for faster builds
            export DOCKER_BUILDKIT=1
            export COMPOSE_DOCKER_CLI_BUILD=1

            # Build with aggressive timeout and monitoring
            echo "ðŸ—ï¸ Starting Docker build with 15-minute hard timeout..."
            timeout 900 docker compose build --parallel --no-cache backend-dev frontend-dev || {
              echo "âŒ Build timed out or failed after 15 minutes"
              echo "ðŸ“‹ System status after failed build:"
              echo "ðŸ’¾ Disk: $(df -h / | tail -1 | awk '{print $4}') available"
              echo "ðŸ§  Memory: $(free -h | grep Mem | awk '{print $7}') available"
              echo "ðŸ” Docker processes:"
              ps aux | grep -E "(docker|compose)" | grep -v grep || echo "No Docker processes"
              exit 1
            }

            echo "âœ… Build completed, starting containers..."
            COMPOSE_PROFILES=dev docker compose up -d --remove-orphans

            echo "â³ Waiting for containers to start..."
            sleep 15

            echo "ðŸ“Š Final deployment status:"
            docker ps
            COMPOSE_PROFILES=dev docker compose ps

            echo "ðŸŽ‰ Development environment rebuild complete!"
            echo "ðŸŒ Backend available on port 4000"
            echo "ðŸŒ Frontend available on port 4001"
