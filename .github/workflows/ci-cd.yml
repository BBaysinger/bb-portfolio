# =============================================================================
# CI/CD Pipeline - BB Portfolio Site
# ===============================================================
# ENVIRONMENT FILES (.env.dev, .env.prod)
# ===============================================================
# These files are NOT sourced from the repo during deployment.
# They are dynamically generated on EC2 by the CI/CD workflow,
# with contents exclusively pulled from GitHub Actions secrets and variables.
# Local development uses .env only.
# ===============================================================
# =============================================================================
#
# This workflow provides automated build, test, and deployment for the
# portfolio application with support for multiple environments:
#
# TRIGGERS:
# - Push to 'main' branch: Full CI/CD with production deployment
# - Push to 'dev' branch: CI/CD with development environment rebuild
# - Manual dispatch: Allows manual triggering for any branch
#
# JOBS:
# 1. build-and-test: Validates code quality and builds both frontend/backend
# 2. deploy-prod: Deploys to AWS EC2 production (main branch only)
# 3. rebuild-dev: Rebuilds development environment (dev branch or manual)
#
# DEPLOYMENT TARGETS:
# - Production: Uses pre-built ECR images for fast, reliable deployments
# - Development: Builds directly on EC2 for flexibility and testing
# =============================================================================

name: CI/CD Pipeline

# Workflow triggers
on:
  push:
    branches:
      - main # Production deployments
      - dev # Development environment rebuilds
  workflow_dispatch: # Manual trigger for any branch

jobs:
  # ==========================================================================
  # BUILD AND TEST JOB
  # ==========================================================================
  # Validates code quality, runs tests, and ensures both frontend and backend
  # can be built successfully before any deployment occurs
  # ==========================================================================
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      # Checkout source code
      - name: Checkout code
        uses: actions/checkout@v4

      # Setup Node.js environment
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20 # LTS version for stability

      # =======================================================================
      # FRONTEND BUILD AND TEST
      # =======================================================================
      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm install --legacy-peer-deps # Required for some peer dependency conflicts

      - name: Build frontend
        working-directory: ./frontend
        env:
          # Ensure profile and backend base are available to prebuild guard and Next.js
          ENV_PROFILE: ${{ github.ref == 'refs/heads/main' && 'prod' || 'dev' }}
          # Bake internal Docker DNS for API rewrites and server fetch base
          # Prefer PROD_/DEV_ prefixed variables if they exist, otherwise fall back to literals
          BACKEND_INTERNAL_URL: ${{ github.ref == 'refs/heads/main' && (secrets.PROD_BACKEND_URL || 'http://backend-prod:3000') || (secrets.DEV_BACKEND_URL || 'http://backend-dev:3000') }}
        run: npm run build # Next.js production build

      - name: Test frontend
        working-directory: ./frontend
        run: npm test || echo "âš ï¸ No frontend tests yet" # Graceful failure until tests are implemented

      # =======================================================================
      # BACKEND BUILD AND TEST
      # =======================================================================
      - name: Install backend dependencies
        working-directory: ./backend
        run: npm install --legacy-peer-deps # Required for some peer dependency conflicts

      - name: Build backend
        working-directory: ./backend
        env:
          # Use dev profile with a dummy connection string just to satisfy build-time checks
          ENV_PROFILE: dev
          DEV_MONGODB_URI: mongodb://localhost:27017/dummy-db
          # Required by strict env checks in payload.config.ts for dev profile
          DEV_PAYLOAD_SECRET: ${{ secrets.DEV_PAYLOAD_SECRET }}
          # Frontend origin for CORS/CSRF checks during build-time config resolution
          DEV_FRONTEND_URL: ${{ secrets.DEV_FRONTEND_URL }}
        run: npm run build # Next.js production build (Payload CMS)

      - name: Test backend
        working-directory: ./backend
        env:
          ENV_PROFILE: dev
          DEV_MONGODB_URI: mongodb://localhost:27017/dummy-db
          DEV_PAYLOAD_SECRET: ${{ secrets.DEV_PAYLOAD_SECRET }}
          DEV_FRONTEND_URL: ${{ secrets.DEV_FRONTEND_URL }}
        run: npm test || echo "âš ï¸ No backend tests yet" # Graceful failure until tests are implemented

  # ==========================================================================
  # PRODUCTION DEPLOYMENT JOB
  # ==========================================================================
  # Deploys to AWS EC2 production environment using pre-built ECR images
  # Only runs on main branch pushes after successful build and test
  # ==========================================================================
  deploy-prod:
    if: github.ref == 'refs/heads/main' # Production deploys only from main branch
    needs: build-and-test # Wait for successful build and test
    runs-on: ubuntu-latest
    timeout-minutes: 15 # Extended timeout for deployment operations

    steps:
      # Checkout source code for docker-compose.yml and deployment scripts
      - name: Checkout code
        uses: actions/checkout@v4

      # =======================================================================
      # AWS AUTHENTICATION AND ECR LOGIN
      # =======================================================================
      # Configure AWS credentials for ECR access and deployment operations
      # =======================================================================
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.CICD_AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.CICD_AWS_SECRET_ACCESS_KEY }}
          aws-region: us-west-2 # Oregon region for EC2 and ECR resources

      # Login to Amazon ECR using AWS CLI authentication
      - name: Login to Amazon ECR
        run: |
          echo "ðŸ” Authenticating with Amazon ECR..."
          aws ecr get-login-password --region us-west-2 \
            | docker login --username AWS --password-stdin 778230822028.dkr.ecr.us-west-2.amazonaws.com

      # =======================================================================
      # DOCKER IMAGE BUILD AND PUSH TO ECR
      # =======================================================================
      # Build production-optimized images and push to ECR registry
      # Uses 'latest' tag for simplicity and fast deployment
      # =======================================================================
      - name: Build and push frontend-prod
        run: |
          echo "Building frontend production image..."
          docker build \
            --build-arg ENV_PROFILE=prod \
            --build-arg BACKEND_INTERNAL_URL=${{ secrets.PROD_BACKEND_URL || 'http://backend-prod:3000' }} \
            -t frontend:latest ./frontend
          echo "ðŸ·ï¸ Tagging frontend image for ECR..."
          docker tag frontend:latest 778230822028.dkr.ecr.us-west-2.amazonaws.com/portfolio/frontend:latest
          echo "ðŸ“¤ Pushing frontend image to ECR..."
          docker push 778230822028.dkr.ecr.us-west-2.amazonaws.com/portfolio/frontend:latest
          echo "Frontend image push complete"

      - name: Build and push backend-prod
        run: |
          echo "Building backend production image..."
          docker build \
            --build-arg ENV_PROFILE=prod \
            --build-arg PROD_MONGODB_URI=mongodb://localhost:27017/dummy-db \
            -t backend:latest ./backend
          echo "ðŸ·ï¸ Tagging backend image for ECR..."
          docker tag backend:latest 778230822028.dkr.ecr.us-west-2.amazonaws.com/portfolio/backend:latest
          echo "ðŸ“¤ Pushing backend image to ECR..."
          docker push 778230822028.dkr.ecr.us-west-2.amazonaws.com/portfolio/backend:latest
          echo "Backend image push complete"

      # =======================================================================
      # EC2 PRODUCTION DEPLOYMENT
      # =======================================================================
      # Deploy to production EC2 instance using SSH automation
      # Handles Docker/AWS CLI installation and zero-downtime deployment
      # =======================================================================
      - name: Deploy prod on EC2
        uses: appleboy/ssh-action@v1.0.3
        timeout-minutes: 15 # Extended timeout for Docker installation and health checks
        with:
          host: ${{ secrets.EC2_HOST }} # EC2 public IP address
          username: ec2-user # Default Amazon Linux user
          key: ${{ secrets.EC2_SSH_KEY }} # SSH private key for authentication
          command_timeout: 12m # Extended SSH command timeout
          script: |
            echo "ðŸš€ Starting production deployment at $(date)"
            echo "ðŸ“ Deploying to: $(hostname)"

            # ===============================================================
            # INFRASTRUCTURE SETUP
            # ===============================================================
            # Install required tools if not present on EC2 instance
            # ===============================================================

            # Install Docker if not present
            if ! command -v docker &> /dev/null; then
              echo "Installing Docker..."
              sudo yum update -y
              sudo yum install -y docker
              sudo systemctl start docker
              sudo systemctl enable docker
              sudo usermod -a -G docker ec2-user
              echo "Docker installation complete"
            else
              echo "Docker already installed"
            fi

            # Install AWS CLI if not present (required for ECR authentication)
            if ! command -v aws &> /dev/null; then
              echo "Installing AWS CLI..."
              sudo yum install -y awscli
              echo "AWS CLI installation complete"
            else
              echo "AWS CLI already installed"
            fi

            # Install Docker Compose plugin if not present
            if ! docker compose version &> /dev/null; then
              echo "Installing Docker Compose..."
              sudo mkdir -p /usr/local/lib/docker/cli-plugins
              sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/lib/docker/cli-plugins/docker-compose
              sudo chmod +x /usr/local/lib/docker/cli-plugins/docker-compose
              echo "Docker Compose installation complete"
            else
              echo "Docker Compose already installed"
            fi

            # =============================================================
            # DOCKER SERVICE PREPARATION
            # =============================================================
            # Ensure Docker daemon is running and ready
            # =============================================================
            echo "Preparing Docker services..."
            sudo systemctl daemon-reload
            sudo systemctl start docker
            sudo systemctl enable docker

            # Wait for docker to be ready
            echo "Waiting for Docker to be ready..."
            sleep 5

            # Verify docker is working
            echo "Verifying Docker installation..."
            sudo docker --version
            echo "Docker verification complete"            # ===============================================================
            # AWS AUTHENTICATION SETUP
            # ===============================================================
            # Configure AWS credentials for ECR access from EC2
            # ===============================================================
            echo "ðŸ” Configuring AWS credentials..."
            aws configure set aws_access_key_id ${{ secrets.CICD_AWS_ACCESS_KEY_ID }}
            aws configure set aws_secret_access_key ${{ secrets.CICD_AWS_SECRET_ACCESS_KEY }}
            aws configure set default.region us-west-2

            # ECR login for both sudo and regular user contexts
            echo "ðŸ” Authenticating with ECR..."
            aws ecr get-login-password --region us-west-2 | sudo docker login --username AWS --password-stdin 778230822028.dkr.ecr.us-west-2.amazonaws.com
            aws ecr get-login-password --region us-west-2 | docker login --username AWS --password-stdin 778230822028.dkr.ecr.us-west-2.amazonaws.com

            # ===============================================================
            # REPOSITORY SETUP
            # ===============================================================
            # Clone or update project repository for docker-compose.yml
            # ===============================================================
            if ! command -v git &> /dev/null; then
              echo "Installing Git..."
              sudo yum install -y git
            fi

            echo "ðŸ“¥ Setting up project repository..."
            cd $HOME
            if [ ! -d "portfolio" ]; then
              echo "ðŸ“¥ Cloning repository..."
              git clone https://github.com/BBaysinger/bb-portfolio.git portfolio
            else
              echo "ðŸ”„ Updating existing repository..."
              cd portfolio
              git fetch origin
              git checkout main
              git reset --hard origin/main
              cd ..
            fi

            # ===============================================================
            # ENVIRONMENT CONFIGURATION
            # ===============================================================
            # Create production environment files from GitHub secrets
            # ===============================================================
            cd ~/portfolio
            echo "âš™ï¸ Creating production environment files..."

            # Backend production environment
            cat > backend/.env.prod << EOF
            PORT=3000
            # Prefix-first envs: use PROD_MONGODB_URI exclusively
            PROD_MONGODB_URI=${{ secrets.PROD_MONGODB_URI }}
            PROD_PAYLOAD_SECRET=${{ secrets.PROD_PAYLOAD_SECRET }}
            # Frontend origin for CORS/CSRF
            PROD_FRONTEND_URL=${{ secrets.PROD_FRONTEND_URL }}
            # AWS S3 Configuration for Payload uploads
            S3_AWS_ACCESS_KEY_ID=${{ secrets.S3_AWS_ACCESS_KEY_ID }}
            S3_AWS_SECRET_ACCESS_KEY=${{ secrets.S3_AWS_SECRET_ACCESS_KEY }}
            PROD_AWS_REGION=${{ secrets.PROD_AWS_REGION }}
            PROD_S3_BUCKET=${{ secrets.PROD_S3_BUCKET }}
            NODE_ENV=production
            ENV_PROFILE=prod
            EOF

            # Frontend production environment
            cat > frontend/.env.prod << EOF
            NODE_ENV=production
            ENV_PROFILE=prod
            # Internal backend URL used for server-side fetch and rewrites
            BACKEND_INTERNAL_URL=${{ secrets.PROD_BACKEND_URL || 'http://backend-prod:3000' }}
            EOF

            # ===============================================================
            # CONTAINER DEPLOYMENT
            # ===============================================================
            # Pull latest images and deploy with zero-downtime strategy
            # ===============================================================
            echo "â¬‡ï¸ Pulling latest production images..."
            sudo COMPOSE_PROFILES=prod docker compose pull || {
              echo "âš ï¸ Failed to pull images. Continuing with existing images..."
            }

            # Deployment status check
            echo "Pre-deployment status check..."
            echo "System resources:"
            df -h | head -5  # Disk space
            free -h          # Memory usage
            echo "ðŸ“ Current user: $(whoami)"
            echo "ðŸ“ Working directory: $(pwd)"

            echo "ðŸš€ Starting production deployment..."
            sudo COMPOSE_PROFILES=prod docker compose up -d

            # ===============================================================
            # HEALTH CHECKS AND VALIDATION
            # ===============================================================
            # Wait for containers to start and validate deployment
            # ===============================================================
            echo "Waiting for containers to initialize..."
            sleep 20

            echo "Checking container logs..."
            echo "=== Backend Container Logs ==="
            sudo docker logs portfolio-backend-prod --tail 50 || echo "âš ï¸ Backend container not found"

            echo "=== Frontend Container Logs ==="
            sudo docker logs portfolio-frontend-prod --tail 50 || echo "âš ï¸ Frontend container not found"

            echo "Final deployment status:"
            sudo docker ps
            sudo COMPOSE_PROFILES=prod docker compose ps

            echo "Production deployment complete at $(date)!"

  # ==========================================================================
  # DEVELOPMENT REBUILD JOB - SIMPLE EC2 BUILD
  # ==========================================================================
  # ==========================================================================
  # DEVELOPMENT REBUILD JOB
  # ==========================================================================
  # Rebuilds development environment directly on EC2 using docker-compose
  # Triggered by pushes to 'dev' branch or manual workflow dispatch
  # Uses simplified approach for flexibility and testing
  # ==========================================================================
  rebuild-dev:
    if: github.ref == 'refs/heads/dev' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Rebuild dev on EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }} # EC2 public IP address
          username: ec2-user # Default Amazon Linux user
          key: ${{ secrets.EC2_SSH_KEY }} # SSH private key for authentication
          script: |
            # =============================================================
            # REPOSITORY SETUP
            # =============================================================
            # Clone or update the project repository
            # =============================================================
            cd $HOME
            if [ ! -d "portfolio" ]; then
              git clone https://github.com/BBaysinger/bb-portfolio.git portfolio
            else
              cd portfolio
              git fetch origin
              git checkout dev
              git reset --hard origin/dev
              cd ..
            fi

            # =============================================================
            # DOCKER INSTALLATION
            # =============================================================
            # Install Docker and Docker Compose if not present
            # =============================================================
            if ! command -v docker &> /dev/null; then
              echo "Installing Docker..."
              sudo yum update -y
              sudo yum install -y docker
              sudo systemctl start docker
              sudo systemctl enable docker
              sudo usermod -a -G docker ec2-user
              echo "Docker installation complete"
            fi

            # Modern Docker includes compose as a plugin, no need to install separately
            echo "Docker Compose is included with Docker installation"

            # =============================================================
            # DOCKER SERVICE PREPARATION
            # =============================================================
            # Ensure Docker daemon is running and ready
            # =============================================================
            echo "Preparing Docker services..."
            sudo systemctl daemon-reload
            sudo systemctl start docker
            sudo systemctl enable docker

            # Wait for docker to be ready
            echo "Waiting for Docker to be ready..."
            sleep 5

            # Verify docker is working
            echo "Verifying Docker installation..."
            sudo docker --version
            echo "Docker verification complete"

            # =============================================================
            # ENVIRONMENT CONFIGURATION
            # =============================================================
            # Create development environment files from GitHub secrets
            # =============================================================
            echo "Configuring environment files..."
            cd $HOME/portfolio

            # Create backend .env.dev
            echo "Creating backend .env.dev..."
            cat > backend/.env.dev << EOF
            PORT=3000
            # Prefix-first envs: use DEV_MONGODB_URI exclusively
            DEV_MONGODB_URI=${{ secrets.DEV_MONGODB_URI }}
            DEV_PAYLOAD_SECRET=${{ secrets.DEV_PAYLOAD_SECRET }}
            # Frontend origin for CORS/CSRF
            DEV_FRONTEND_URL=${{ secrets.DEV_FRONTEND_URL }}
            # AWS S3 Configuration for Payload uploads
            S3_AWS_ACCESS_KEY_ID=${{ secrets.S3_AWS_ACCESS_KEY_ID }}
            S3_AWS_SECRET_ACCESS_KEY=${{ secrets.S3_AWS_SECRET_ACCESS_KEY }}
            DEV_AWS_REGION=${{ secrets.DEV_AWS_REGION }}
            DEV_S3_BUCKET=${{ secrets.DEV_S3_BUCKET }}
            NODE_ENV=development
            ENV_PROFILE=dev
            EOF

            # Create frontend .env.dev
            echo "Creating frontend .env.dev..."
            cat > frontend/.env.dev << EOF
            NODE_ENV=development
            ENV_PROFILE=dev
            BACKEND_INTERNAL_URL=${{ secrets.DEV_BACKEND_URL || 'http://backend-dev:3000' }}
            EOF
            echo "Environment configuration complete"

            # =============================================================
            # CONTAINER DEPLOYMENT
            # =============================================================
            # Deploy development environment with docker-compose
            # Uses dev profile and builds images directly on EC2
            # =============================================================
            echo "Starting container deployment..."
            echo "Current directory: $(pwd)"
            echo "Docker Compose version: $(sudo docker compose version)"

            echo "Building and starting development containers..."
            echo "âš ï¸  Note: Docker builds may take a few minutes on t3.small instances"

            # Try building with timeout (use sudo for Docker commands)
            timeout 600 sudo COMPOSE_PROFILES=dev docker compose up -d --build || {
              echo "Build timed out or failed, trying without --build flag..."
              sudo COMPOSE_PROFILES=dev docker compose up -d
            }

            echo "Development environment rebuild complete!"
            echo "Backend available on port 4000"
            echo "Frontend available on port 4001"

            echo "Container status:"
            sudo docker ps
