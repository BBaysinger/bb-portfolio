# Redeploy Workflow (prod + dev restart & env injection)
name: Redeploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: Which profiles to (re)start
        type: choice
        required: true
        default: both
        options:
          - prod
          - dev
          - both
      start_dev:
        description: Ensure dev containers are up in addition to prod
        type: choice
        required: true
        default: "true"
        options:
          - "true"
          - "false"
      refresh_env:
        description: Regenerate and upload .env files to EC2 (requires secrets)
        type: choice
        required: true
        default: "false"
        options:
          - "true"
          - "false"
      restart_containers:
        description: (Re)start containers on EC2 (docker compose pull/up)
        type: choice
        required: true
        default: "true"
        options:
          - "true"
          - "false"

  workflow_call:
    inputs:
      environment:
        description: Which profiles to (re)start
        type: string
        required: true
        default: both
      start_dev:
        description: Ensure dev containers are up in addition to prod
        type: string
        required: true
        default: "true"
      refresh_env:
        description: Regenerate and upload .env files to EC2 (requires secrets)
        type: string
        required: true
        default: "false"
      restart_containers:
        description: (Re)start containers on EC2 (docker compose pull/up)
        type: string
        required: true
        default: "true"

jobs:
  deploy:
    name: SSH redeploy (${{ matrix.target }})
    runs-on: ubuntu-latest
    timeout-minutes: 30
    environment: ${{ matrix.target }}
    strategy:
      fail-fast: false
      matrix:
        target: >-
          ${{ fromJson(
            inputs.environment == 'both'
              ? ((inputs.start_dev == 'true' || inputs.start_dev == true) ? '["prod","dev"]' : '["prod"]')
              : format('["{0}"]', inputs.environment)
          ) }}
    # Prevent overlapping prod/dev redeploys from stepping on each other.
    # Use per-environment concurrency so prod and dev can proceed independently.
    # If environment == 'both', fall back to a single global group.
    concurrency:
      group: ${{ inputs.environment == 'both' && 'redeploy-global' || format('redeploy-{0}', matrix.target) }}
      cancel-in-progress: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install env tooling dependencies
        run: npm ci --ignore-scripts

      - name: Prepare SSH key
        id: ssh
        env:
          SSH_KEY_PEM: ${{ secrets.EC2_SSH_KEY_PEM }}
          SSH_KEY_ALT: ${{ secrets.EC2_SSH_KEY }}
        run: |
          set -euo pipefail
          CONTENT="${SSH_KEY_PEM:-}"
          if [ -z "$CONTENT" ] && [ -n "${SSH_KEY_ALT:-}" ]; then
            CONTENT="$SSH_KEY_ALT"
          fi
          if [ -z "$CONTENT" ]; then
            echo "Missing SSH key secret: provide EC2_SSH_KEY_PEM or EC2_SSH_KEY" >&2
            exit 1
          fi
          umask 177
          printf "%s" "$CONTENT" > key.pem
          echo "key=key.pem" >> "$GITHUB_OUTPUT"

      - name: Validate required inputs
        env:
          ENVIRONMENT: ${{ matrix.target }}
          EC2_HOST: ${{ secrets.EC2_HOST }}
          REFRESH_ENV: ${{ inputs.refresh_env }}
        run: |
          set -euo pipefail
          : "${ENVIRONMENT}"
          : "${EC2_HOST}"
          : "${REFRESH_ENV}"

      - name: Generate env files (in runner temp)
        id: genenv
        if: ${{ inputs.refresh_env == 'true' || inputs.refresh_env == true }}
        env:
          PROFILES: ${{ matrix.target }}
          GENERATE_ENV_FROM_ENV: "true"
          AWS_REGION: ${{ secrets.AWS_REGION }}
          S3_REGION: ${{ secrets.S3_REGION }}
          S3_BUCKET: ${{ secrets.S3_BUCKET }}
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
          PAYLOAD_SECRET: ${{ secrets.PAYLOAD_SECRET }}
          FRONTEND_URL: ${{ secrets.FRONTEND_URL }}
          PUBLIC_SERVER_URL: ${{ secrets.PUBLIC_SERVER_URL }}
          BACKEND_INTERNAL_URL: ${{ secrets.BACKEND_INTERNAL_URL }}
          PUBLIC_PROJECTS_BUCKET: ${{ secrets.PUBLIC_PROJECTS_BUCKET }}
          PUBLIC_PROJECTS_PREFIX: ${{ secrets.PUBLIC_PROJECTS_PREFIX }}
          NDA_PROJECTS_BUCKET: ${{ secrets.NDA_PROJECTS_BUCKET }}
          NDA_PROJECTS_PREFIX: ${{ secrets.NDA_PROJECTS_PREFIX }}
          SES_FROM_EMAIL: ${{ secrets.SES_FROM_EMAIL }}
          SES_TO_EMAIL: ${{ secrets.SES_TO_EMAIL }}
          SMTP_FROM_EMAIL: ${{ secrets.SMTP_FROM_EMAIL }}
          SECURITY_TXT_EXPIRES: ${{ secrets.SECURITY_TXT_EXPIRES }}
          REQUIRED_ENVIRONMENT_VARIABLES: ${{ secrets.REQUIRED_ENVIRONMENT_VARIABLES }}
          NEXT_PUBLIC_RUM_APP_MONITOR_ID: ${{ secrets.NEXT_PUBLIC_RUM_APP_MONITOR_ID }}
          NEXT_PUBLIC_RUM_IDENTITY_POOL_ID: ${{ secrets.NEXT_PUBLIC_RUM_IDENTITY_POOL_ID }}
          NEXT_PUBLIC_RUM_GUEST_ROLE_ARN: ${{ secrets.NEXT_PUBLIC_RUM_GUEST_ROLE_ARN }}
          NEXT_PUBLIC_RUM_REGION: ${{ secrets.NEXT_PUBLIC_RUM_REGION }}
        run: bash deploy/scripts/actions/generate-env-files.sh

      - name: Archive env files artifact
        if: ${{ inputs.refresh_env == 'true' || inputs.refresh_env == true }}
        # Temporary helper so we can inspect generated .env bundles.
        # This leaks secrets to Actions artifacts; remove when no longer needed.
        run: |
          set -euo pipefail
          tar -czf env-files-${{ matrix.target }}.tar.gz -C "${{ steps.genenv.outputs.dir }}" .

      - name: Upload env files artifact
        if: ${{ inputs.refresh_env == 'true' || inputs.refresh_env == true }}
        # See warning above: artifacts expose decrypted secrets to anyone with run access.
        uses: actions/upload-artifact@v4
        with:
          name: env-files-${{ matrix.target }}
          path: env-files-${{ matrix.target }}.tar.gz
          if-no-files-found: error

      - name: Upload env files to EC2
        if: ${{ inputs.refresh_env == 'true' || inputs.refresh_env == true }}
        env:
          ENVIRONMENT: ${{ matrix.target }}
          START_DEV: ${{ inputs.start_dev }}
          EC2_HOST: ${{ secrets.EC2_HOST }}
          OUT_DIR: ${{ steps.genenv.outputs.dir }}
          SSH_OPTS: -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ConnectTimeout=10 -o ServerAliveInterval=5 -o ServerAliveCountMax=2 -o PreferredAuthentications=publickey -o PubkeyAuthentication=yes -o TCPKeepAlive=yes -o Compression=yes
        run: bash deploy/scripts/actions/upload-env-files.sh "${{ steps.ssh.outputs.key }}"

      - name: Upload compose file to EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
        run: bash deploy/scripts/actions/upload-compose.sh "${{ steps.ssh.outputs.key }}"

      - name: Sync Nginx config and reload
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          ENVIRONMENT: ${{ matrix.target }}
        run: bash deploy/scripts/actions/sync-nginx.sh "${{ steps.ssh.outputs.key }}"

      - name: (Re)start containers
        if: ${{ inputs.restart_containers == 'true' || inputs.restart_containers == true }}
        env:
          ENVIRONMENT: ${{ matrix.target }}
          START_DEV: ${{ inputs.start_dev }}
          EC2_HOST: ${{ secrets.EC2_HOST }}
        run: bash deploy/scripts/actions/restart-containers.sh "${{ steps.ssh.outputs.key }}"

      - name: Diagnose services (containers and nginx)
        if: failure()
        env:
          ENVIRONMENT: ${{ matrix.target }}
          EC2_HOST: ${{ secrets.EC2_HOST }}
        run: bash deploy/scripts/actions/diagnose-services.sh "${{ steps.ssh.outputs.key }}"

      - name: Health checks
        if: always()
        env:
          ENVIRONMENT: ${{ matrix.target }}
          START_DEV: ${{ inputs.start_dev }}
          EC2_HOST: ${{ secrets.EC2_HOST }}
          # Use extended defaults aligned with container start_period and grace logic
          HEALTH_ATTEMPTS: 12
          HEALTH_DELAY_SECONDS: 5
          CURL_ATTEMPTS: 6
          CURL_DELAY_SECONDS: 5
          CURL_MAX_TIME_SECONDS: 5
          CURL_CONNECT_TIMEOUT: 2
          HEALTH_STARTING_GRACE_SECONDS: 40
        run: bash deploy/scripts/actions/health-checks.sh "${{ steps.ssh.outputs.key }}"

      - name: Dump container logs on failure
        if: failure()
        env:
          ENVIRONMENT: ${{ matrix.target }}
          EC2_HOST: ${{ secrets.EC2_HOST }}
        run: bash deploy/scripts/actions/dump-logs.sh "${{ steps.ssh.outputs.key }}"
